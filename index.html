<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigitMCQ Master - AI Competitive Exam Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML2Canvas CDN for JPG/Image Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom Styles and Inter Font for a Pro Look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; 
            color: #1f2937; 
        }
        
        /* Full-screen Overlay (Fixed Positioning) for Anti-Cheating and scroll fix */
        #app-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #f0f4f8;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 9999;
            padding-bottom: 20px;
        }

        /* Primary Button Style (Deep Blue) */
        .btn-primary {
            background-image: linear-gradient(to right, #005ce6, #1e40af, #1d4ed8);
            color: white;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 6px 15px -3px rgba(30, 64, 175, 0.4), 0 2px 4px -2px rgba(30, 64, 175, 0.2);
            font-weight: 600;
        }
        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 12px 25px -5px rgba(30, 64, 175, 0.6), 0 6px 10px -5px rgba(30, 64, 175, 0.4);
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            background-image: none;
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Exam Option Interactive Styling */
        .option-item {
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 2px solid #e5e7eb;
            user-select: none;
        }
        .option-item:hover {
            border-color: #60a5fa;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .option-selected {
            border-color: #1d4ed8 !important;
            background-color: #2563eb !important;
            color: white !important;
            transform: scale(1.005) translateY(-1px);
            box-shadow: 0 8px 15px rgba(37, 99, 235, 0.4);
        }
        .option-selected .option-key {
            color: white !important;
        }

        /* Timer and Progress Bar */
        #timer-display {
            font-variant-numeric: tabular-nums;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            font-weight: 700;
        }
        
        /* Certificate & Signature */
        .certificate {
            background: linear-gradient(135deg, #ffffff, #f7f7f7);
            border: 10px solid #fbbf24; 
            padding: 40px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .cert-header { 
            font-size: 3rem; 
            font-weight: 800; 
        }
        .signature {
            font-family: 'Brush Script MT', cursive;
            font-size: 2.8rem;
            color: #ef4444; 
        }
        
        /* Marksheet Table Styling */
        .marksheet-table th { background-color: #eff6ff; color: #1e40af; }
        .marksheet-correct { background-color: #f0fff4; }
        .marksheet-incorrect { background-color: #fff0f0; }

    </style>
</head>
<body>

<div id="app-container" class="p-4 sm:p-8">
    <header class="text-center mb-8 pt-4">
        <h1 class="text-4xl font-extrabold text-gray-900 leading-tight">
            <span class="text-blue-600">DigitMCQ</span> Master üöÄ
        </h1>
        <p class="text-gray-500 mt-1 text-lg">AI-Powered Competitive Exam Preparation</p>
    </header>

    <!-- 1. Configuration/Setup Screen -->
    <div id="setup-screen" class="max-w-xl mx-auto p-6 bg-white rounded-xl shadow-2xl transition-all duration-500 border-t-4 border-blue-600">
        <h2 class="text-2xl font-bold mb-6 text-blue-700">Exam Setup & Customization</h2>
        
        <div class="space-y-5">
            <div>
                <label for="user-name" class="block text-sm font-semibold text-gray-700">Your Name (For Certificate):</label>
                <input type="text" id="user-name" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Enter Your Full Name" required>
            </div>
            
            <div>
                <label for="exam-topic" class="block text-sm font-semibold text-gray-700">Select Exam / Subject:</label>
                <select id="exam-topic" onchange="toggleCustomTopic()" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white shadow-sm" required>
                    <option value="" disabled selected>--- Select an Exam Category ---</option>
                    
                    <optgroup label="Assam State Exams">
                        <option value="HSLC (Class 10) General Science">HSLC (Class 10)</option>
                        <option value="HSSLC (Class 12) Arts & Commerce General Studies">HSSLC (Class 12)</option>
                        <option value="Polytechnic PAT (General Knowledge and Science)">Polytechnic PAT</option>
                        <option value="ITI Entrance General Awareness">ITI Entrance</option>
                        <option value="Assam CEE (Physics and Chemistry for Engineering)">Assam CEE</option>
                        <option value="D.El.Ed PET General Awareness and Reasoning">D.El.Ed PET</option>
                        <option value="ADR Grade 3 General Studies & Aptitude">ADR Grade 3</option>
                        <option value="ADR Grade 4 General Knowledge & Basic Math">ADR Grade 4</option>
                        <option value="APSC CCE General Studies Paper 1">APSC CCE</option>
                        <option value="Assam Police Constable (General Knowledge and Reasoning)">Assam Police Constable</option>
                        <option value="Assam Police SI (General Studies and Law Basics)">Assam Police SI</option>
                        <option value="Assam TET Child Pedagogy and Language">Assam TET</option>
                        <option value="Assam General Knowledge and Culture">Assam GK & Culture</option>
                    </optgroup>

                    <optgroup label="National Exams">
                        <option value="JEE Main (Physics, Chemistry, Math)">JEE Main</option>
                        <option value="NEET UG (Physics, Chemistry, Biology)">NEET UG</option>
                        <option value="CUET UG (General Test and English)">CUET UG</option>
                        <option value="SSC GD (General Knowledge and Elementary Math)">SSC GD</option>
                        <option value="SSC MTS (General Awareness and Numerical Aptitude)">SSC MTS</option>
                        <option value="SSC CHSL (English Language and Quantitative Aptitude)">SSC CHSL</option>
                        <option value="SSC CGL (General Intelligence and Reasoning)">SSC CGL</option>
                        <option value="RRB Group D (General Science and Current Affairs)">RRB Group D</option>
                    </optgroup>

                    <optgroup label="General Subjects">
                        <option value="Advanced English Grammar and Vocabulary">English Grammar</option>
                        <option value="Advanced Mathematics and Quantitative Aptitude">Maths / Aptitude</option>
                        <option value="Basic Computer Science and IT">Computer Science</option>
                    </optgroup>
                    
                    <option value="custom">‚úçÔ∏è Custom Topic (Premium)</option>
                </select>
            </div>
            
            <!-- Medium of Exam Selection -->
            <div>
                <label for="exam-language" class="block text-sm font-semibold text-gray-700">Exam Medium (Language):</label>
                <select id="exam-language" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white shadow-sm" required>
                    <option value="English" selected>English (Default)</option>
                    <option value="Assamese">Assamese</option>
                    <option value="Hindi">Hindi</option>
                </select>
            </div>

            <!-- Custom Topic Field (Initially Hidden) -->
            <div id="custom-topic-container" class="hidden">
                <label for="custom-topic-input" class="block text-sm font-semibold text-gray-700">Enter Custom Exam Topic (Be Detailed):</label>
                <input type="text" id="custom-topic-input" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="e.g., Indian Economy post-1991 reforms">
            </div>

            <div>
                <label for="question-count" class="block text-sm font-semibold text-gray-700">Questions & Time Limit:</label>
                <select id="question-count" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white shadow-sm" required>
                    <option value="10">10 Questions (5 Mins)</option>
                    <option value="25" selected>25 Questions (15 Mins)</option>
                    <option value="50">50 Questions (30 Mins)</option>
                    <option value="100-premium">100 Questions (60 Mins) - Premium üîí</option>
                </select>
            </div>

            <!-- Premium Code Field (Only shown if 100-Q or Custom is selected) -->
            <div id="premium-code-container" class="hidden p-4 bg-yellow-50 rounded-lg border border-yellow-300 transition-all">
                <label for="premium-code-input" class="block text-sm font-semibold text-yellow-800">Premium Access Code (For Custom/100-Q):</label>
                <input type="text" id="premium-code-input" class="mt-1 block w-full p-3 border border-yellow-500 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 shadow-inner uppercase" placeholder="Enter Premium Code">
                <button onclick="openWhatsAppForPremium('Premium Code')" class="mt-3 w-full py-2 text-sm bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors font-semibold">
                    WhatsApp for Premium Code üì≤
                </button>
            </div>
        </div>

        <div id="error-message" class="text-red-600 text-sm mt-4 font-medium hidden p-2 bg-red-100 rounded-lg border border-red-300"></div>
        
        <button onclick="startLoading()" class="btn-primary w-full mt-8 py-3 rounded-lg text-lg shadow-xl">
            Start AI Exam üß†
        </button>
    </div>

    <!-- 2. Loading Screen -->
    <div id="loading-screen" class="hidden max-w-md mx-auto p-10 text-center bg-white rounded-xl shadow-2xl border-t-4 border-blue-600">
        <div class="flex justify-center mb-6">
            <div class="spinner rounded-full border-8 border-t-8 border-blue-600 w-16 h-16 animate-spin"></div>
        </div>
        <p class="text-2xl font-extrabold text-blue-600">Generating Questions...</p>
        <p class="text-gray-500 mt-2">Gemini AI is preparing your test. Please wait.</p>
        <p class="text-sm mt-4 text-red-500 font-medium bg-red-50 p-2 rounded">‚ö†Ô∏è Full-screen mode starts now. The timer will begin immediately. Do not switch tabs!</p>
    </div>

    <!-- 3. Exam Screen -->
    <div id="exam-screen" class="hidden flex-grow flex flex-col max-w-3xl mx-auto w-full p-0 bg-white rounded-xl shadow-2xl overflow-hidden">
        
        <!-- Header: Timer and Progress -->
        <div class="bg-blue-800 p-4 flex justify-between items-center text-white sticky top-0 z-10 shadow-lg">
            <p id="exam-progress" class="text-lg font-bold">Question 1 / 10</p>
            <div class="text-center">
                <p class="text-sm opacity-80">Time Remaining</p>
                <div id="timer-display" class="bg-red-500 px-4 py-1 rounded-lg text-2xl">00:00</div>
            </div>
            <p id="exam-topic-display" class="text-sm font-medium opacity-80 truncate max-w-[30%] text-right">Topic: General</p>
        </div>

        <!-- Question Body -->
        <div class="p-6 md:p-8 flex-grow flex flex-col">
            <div id="question-container" class="min-h-[250px] mb-8 flex-grow">
                <p id="current-question" class="text-2xl font-extrabold text-gray-900 mb-8 leading-relaxed animate-fade-in border-l-4 border-blue-500 pl-3">
                    <!-- Question will be inserted here -->
                </p>

                <div id="options-container" class="space-y-4">
                    <!-- Options will be inserted here -->
                </div>
            </div>

            <!-- Navigation Buttons (Fixed to the bottom) -->
            <div class="flex justify-between mt-auto space-x-4 pt-4 border-t border-gray-200">
                <button onclick="previousQuestion()" id="prev-btn" class="py-3 px-6 rounded-lg text-xl transition-transform disabled:opacity-50 bg-gray-400 hover:bg-gray-500 text-white shadow-md" disabled>
                    Previous
                </button>
                <button onclick="nextQuestion(true)" id="next-btn" class="btn-primary flex-grow py-3 rounded-lg text-xl transition-transform disabled:opacity-50 shadow-md" disabled>
                    Next Question
                </button>
            </div>
        </div>
    </div>

    <!-- 4. Certificate & Result Screen -->
    <div id="certificate-screen" class="hidden max-w-4xl mx-auto p-4 flex-grow w-full">
        <div class="certificate rounded-2xl" id="certificate-content">
            <div class="text-center">
                <h2 class="text-2xl font-bold text-blue-700">DigitX</h2>
                <p class="text-sm text-gray-500">A unit of DigitMart Electronics</p>
            </div>
            
            <p class="text-xl text-green-600 font-bold mt-4 mb-3">CONGRATULATIONS!</p>
            <h1 class="cert-header text-red-500">CERTIFICATE OF EXCELLENCE</h1>
            
            <p class="text-xl text-gray-600 italic mt-8">
                This prestigious certificate is awarded to
            </p>
            
            <p id="cert-user-name" class="text-4xl text-gray-900 mt-3 mb-4 font-extrabold tracking-wide uppercase border-b-2 border-yellow-500 inline-block px-4 py-2"></p>
            
            <p class="text-xl font-medium text-gray-700 mt-4">
                for successfully completing the AI-Generated Assessment on:
            </p>
            <p id="cert-exam-details" class="text-2xl text-blue-600 mt-2 font-extrabold"></p>

            <div class="mt-8 mb-8 border-t-4 border-b-4 border-gray-200 py-6 bg-blue-50 rounded-lg shadow-inner">
                 <p class="text-2xl text-blue-800 font-bold">Achieved Score:</p>
                 <p id="cert-score-display" class="text-5xl text-green-600 font-extrabold mt-2"></p>
                 <p id="cert-percentage-display" class="text-3xl text-blue-600 font-bold mt-1"></p>
            </div>
            
            <!-- Signatures and Details -->
            <div class="flex justify-around items-end mt-12 text-center">
                <div>
                    <p class="border-b-2 border-gray-500 w-32 mx-auto"></p>
                    <p class="text-sm font-medium mt-2 text-gray-700">Date: <span id="cert-date"></span></p>
                </div>
                <div>
                    <p id="rouf-signature" class="signature">Rouf</p>
                    <p class="border-b-2 border-red-400 w-32 mx-auto"></p>
                    <p class="text-sm font-medium mt-2 text-gray-700">Verified by Rouf Uddin Ahmed</p>
                </div>
            </div>

            <p class="text-sm mt-8 text-gray-500 leading-tight">
                **Issued By:** DigitX, DigitMart Electronics.
                <br>
                **Address:** Bhojkhowa chapori daily market, Tezpur sonitpur, Assam 784027.
                <br>
                **Contact:** 9957189963.
            </p>
        </div>
        
        <div class="max-w-4xl mx-auto text-center mt-6 space-y-4">
            <button onclick="downloadCertificate()" class="btn-primary py-3 px-8 rounded-lg font-semibold w-full sm:w-auto shadow-lg">
                Download Certificate (JPG) ‚¨áÔ∏è
            </button>
            <div id="marksheet-gate-container" class="mt-4">
                <button onclick="toggleMarksheet()" id="marksheet-btn" class="py-2 px-6 rounded-lg font-semibold bg-red-500 hover:bg-red-600 text-white transition-colors shadow-md">
                    View Full Marksheet (Premium Required)
                </button>
                <p id="premium-marksheet-msg" class="text-sm text-red-700 mt-2 hidden">
                    Marksheet is Premium. Contact us via WhatsApp for the code!
                </p>
            </div>
            <button onclick="window.location.reload()" class="py-2 px-8 rounded-lg font-semibold bg-gray-300 text-gray-800 hover:bg-gray-400 transition-colors">
                Start New Exam üîÑ
            </button>
        </div>
        
        <!-- Actual Marksheet (Initially Hidden) -->
        <div id="marksheet-view" class="hidden mt-8 text-left max-w-4xl mx-auto max-h-[500px] overflow-y-auto border border-gray-300 p-4 rounded-xl bg-white shadow-2xl">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Detailed Performance Analysis (Marksheet)</h3>
            <table class="marksheet-table w-full border-collapse text-sm">
                <thead>
                    <tr>
                        <th class="p-2 border text-left">#</th>
                        <th class="p-2 border text-left">Question</th>
                        <th class="p-2 border text-left hidden sm:table-cell">Your Answer</th>
                        <th class="p-2 border text-left">Correct Answer</th>
                        <th class="p-2 border text-left">Result</th>
                    </tr>
                </thead>
                <tbody id="marksheet-body">
                    <!-- Marksheet rows will be inserted here -->
                </tbody>
            </table>
        </div>

    </div>

    <!-- Premium Code Entry Modal -->
    <div id="premium-code-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-[10001]">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-4 border-red-500">
            <h3 class="text-xl font-bold text-red-600 mb-4">üîê Enter Premium Code</h3>
            <p class="text-gray-600 mb-4">Enter the Premium Code to access the Marksheet.</p>
            <input type="text" id="marksheet-premium-code" class="mt-1 block w-full p-3 border border-red-500 rounded-lg focus:ring-red-500 focus:border-red-500 shadow-inner uppercase" placeholder="Enter Premium Code">
            
            <button onclick="checkMarksheetCode()" class="btn-primary py-2 px-6 rounded-lg font-medium mt-4 w-full">Unlock Marksheet</button>
            <button onclick="hidePremiumCodeModal(); openWhatsAppForPremium('Marksheet Premium Code')" class="py-2 px-6 rounded-lg font-medium mt-2 w-full bg-green-500 text-white">WhatsApp for Code üì≤</button>
        </div>
    </div>

    <!-- Generic Message Box (Modal) -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-[10000]">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-4 border-blue-500">
            <p id="message-text" class="text-lg font-semibold text-gray-700 mb-4"></p>
            <button onclick="hideMessage()" class="btn-primary py-2 px-6 rounded-lg font-medium">OK</button>
        </div>
    </div>

</div>

<script>
    // Global variables
    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let userName = '';
    let examTopic = '';
    let examLanguage = 'English'; 
    let questionCount = 0;
    let selectedAnswer = null;
    let userAnswers = []; // Stores {qIndex, userAnswerKey, correctAnswerKey, isCorrect, options}
    let timerInterval;
    let timeRemaining = 0;
    let isMarksheetUnlocked = false; 
    let autoNextTimeout; // New variable for auto-next delay

    // --- Secret Premium Code ---
    const PREMIUM_CODE = "DIGITMART"; 
    // ----------------------------
    
    // --- User-Provided API Key ---
    const apiKey = "AIzaSyCmPT4_hcAE8EzlH0rFN2cEyycb3--Thrw"; 
    // ----------------------------

    // Maps question count to time limit in seconds
    const TIME_MAP = {
        '10': 300,  // 5 minutes
        '25': 900,  // 15 minutes
        '50': 1800, // 30 minutes
        '100': 3600 // 60 minutes
    };
    
    // --- Utility Functions ---

    function showMessage(text) {
        document.getElementById('message-text').textContent = text;
        document.getElementById('message-box').classList.remove('hidden');
        document.getElementById('message-box').classList.add('flex');
    }

    function hideMessage() {
        document.getElementById('message-box').classList.add('hidden');
        document.getElementById('message-box').classList.remove('flex');
    }
    
    function showPremiumCodeModal() {
        document.getElementById('premium-code-modal').classList.remove('hidden');
        document.getElementById('premium-code-modal').classList.add('flex');
        document.getElementById('marksheet-premium-code').value = ''; 
    }
    
    function hidePremiumCodeModal() {
        document.getElementById('premium-code-modal').classList.add('hidden');
        document.getElementById('premium-code-modal').classList.remove('flex');
    }

    function toggleCustomTopic() {
        const examSelect = document.getElementById('exam-topic').value;
        const customContainer = document.getElementById('custom-topic-container');
        const premiumContainer = document.getElementById('premium-code-container');
        const qCountSelect = document.getElementById('question-count');

        const isPremiumNeeded = (examSelect === 'custom' || qCountSelect.value === '100-premium');

        if (examSelect === 'custom') {
            customContainer.classList.remove('hidden');
            premiumContainer.classList.remove('hidden');
        } else {
            customContainer.classList.add('hidden');
            document.getElementById('custom-topic-input').value = ''; 
            
            if (qCountSelect.value !== '100-premium') {
                premiumContainer.classList.add('hidden');
                document.getElementById('premium-code-input').value = '';
            }
        }
    }
    
    document.getElementById('question-count').addEventListener('change', function() {
        const qCountSelect = this.value;
        const premiumContainer = document.getElementById('premium-code-container');
        const examSelect = document.getElementById('exam-topic').value;

        if (qCountSelect === '100-premium' || examSelect === 'custom') {
            premiumContainer.classList.remove('hidden');
        } else {
            if (examSelect !== 'custom') {
                premiumContainer.classList.add('hidden');
                document.getElementById('premium-code-input').value = '';
            }
        }
    });

    function openWhatsAppForPremium(feature) {
        userName = document.getElementById('user-name').value.trim() || 'Student';
        const phoneNumber = '919957189963'; 
        const message = `Hello, I am interested in the DigitMCQ Premium Code. I am contacting from the exam site regarding the "${feature}" feature. My name is ${userName}. I would like to purchase the code.`;
        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
    
    // Function to handle exponential backoff for API calls
    async function fetchWithRetry(url, options, maxRetries = 3) {
        let lastError = null;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    console.error(`Attempt ${i + 1} received HTTP status: ${response.status}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                lastError = error;
                const delay = Math.pow(2, i) * 1000;
                console.warn(`Fetch attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
        throw new Error(`Failed to fetch after ${maxRetries} attempts. Last error: ${lastError.message}`);
    }


    // --- Timer Logic ---
    function startTimer() {
        const qCountValue = document.getElementById('question-count').value;
        const qKey = qCountValue.includes('-premium') ? '100' : qCountValue;
        timeRemaining = TIME_MAP[qKey];
        updateTimerDisplay();

        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                showMessage("Time's Up! The Exam Has Been Automatically Submitted.");
                finishExam();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const timerElement = document.getElementById('timer-display');
        
        timerElement.textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
        // Visual warning for low time
        if (timeRemaining < 60) {
            timerElement.classList.remove('bg-red-500');
            timerElement.classList.add('bg-red-700', 'animate-pulse');
        } else if (timeRemaining < 120) {
             timerElement.classList.remove('bg-red-700', 'animate-pulse');
             timerElement.classList.add('bg-red-500');
        }
        // If time is plenty, keep standard color
        if (timeRemaining >= 120) {
             timerElement.classList.remove('bg-red-700', 'animate-pulse');
             timerElement.classList.add('bg-red-500');
        }
    }


    // --- Core Logic ---

    function startLoading() {
        userName = document.getElementById('user-name').value.trim();
        let selectedTopic = document.getElementById('exam-topic').value;
        examLanguage = document.getElementById('exam-language').value; 
        let qCountValue = document.getElementById('question-count').value;
        let customTopicInput = document.getElementById('custom-topic-input').value.trim();
        let premiumCode = document.getElementById('premium-code-input').value.trim().toUpperCase();
        
        isMarksheetUnlocked = (premiumCode === PREMIUM_CODE);

        if (!userName || !selectedTopic || !qCountValue) {
            document.getElementById('error-message').textContent = "Please enter your Name, select an Exam, and Question Count.";
            document.getElementById('error-message').classList.remove('hidden');
            return;
        }
        
        let hasPremiumAccess = (premiumCode === PREMIUM_CODE);

        // 1. Custom Topic Check
        if (selectedTopic === 'custom') {
            if (!customTopicInput) {
                document.getElementById('error-message').textContent = "Please enter a topic for the Custom Exam.";
                document.getElementById('error-message').classList.remove('hidden');
                return;
            }
            if (!hasPremiumAccess) {
                document.getElementById('error-message').textContent = `Custom Topics are Premium. Enter the code or contact us via WhatsApp.`;
                document.getElementById('error-message').classList.remove('hidden');
                return;
            }
            examTopic = customTopicInput;
        } else {
            examTopic = selectedTopic;
        }

        // 2. 100 Question Count Check
        if (qCountValue === '100-premium') {
             if (!hasPremiumAccess) {
                document.getElementById('error-message').textContent = `The 100-Question Exam is Premium. Enter the code or contact us via WhatsApp.`;
                document.getElementById('error-message').classList.remove('hidden');
                return;
            }
            questionCount = 100;
        } else {
            questionCount = parseInt(qCountValue);
        }
        
        document.getElementById('error-message').classList.add('hidden');
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('loading-screen').classList.remove('hidden');

        generateQuestions();
    }

    function enterFullScreen() {
        const element = document.documentElement;
        if (element.requestFullscreen) {
            element.requestFullscreen();
        } else if (element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
        } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
        } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
        }
    }

    async function generateQuestions() {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const systemPrompt = `You are an expert educational content generator. Your task is to create ${questionCount} multiple-choice questions (MCQs) for an exam on the subject: "${examTopic}". The output MUST be a JSON array of objects following the provided schema. Generate all 'question' and 'options' text strictly in ${examLanguage}. Ensure each question has exactly 4 options (A, B, C, D) and a single correct answer.`;
        
        const userQuery = `Generate ${questionCount} multiple-choice questions on the topic: ${examTopic} for a professional assessment. Focus on the specified Indian/Assam exam standards if mentioned. Generate questions and options in the language: ${examLanguage}.`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "question": { "type": "STRING", "description": "The question text." },
                            "options": {
                                "type": "OBJECT",
                                "properties": {
                                    "A": { "type": "STRING" },
                                    "B": { "type": "STRING" },
                                    "C": { "type": "STRING" },
                                    "D": { "type": "STRING" }
                                },
                                "propertyOrdering": ["A", "B", "C", "D"],
                                "description": "The four options for the MCQ."
                            },
                            "correctAnswer": { "type": "STRING", "description": "The key of the correct option: A, B, C, or D" }
                        },
                        "required": ["question", "options", "correctAnswer"]
                    }
                }
            }
        };

        const options = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        };

        try {
            const response = await fetchWithRetry(apiUrl, options);
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0) {
                const jsonText = result.candidates[0].content.parts[0].text;
                questions = JSON.parse(jsonText);
                
                if (questions.length === 0) {
                    throw new Error("AI could not generate questions. Please try changing the Topic or Language.");
                }

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('exam-screen').classList.remove('hidden');
                
                enterFullScreen();
                startTimer();
                displayQuestion();

            } else {
                throw new Error("AI Response Format Error or Missing Content.");
            }

        } catch (error) {
            console.error("Gemini API Error:", error);
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
            showMessage(`Fatal Error: Question Generation Failed. Error: ${error.message}`);
        }
    }

    function recordAnswer() {
        // Record the selected answer for the current question index
        if (selectedAnswer) {
            const qData = questions[currentQuestionIndex];
            const isCorrect = (selectedAnswer === qData.correctAnswer);
            
            // Check if answer for this question already exists and update it, otherwise push new one
            let existingAnswerIndex = userAnswers.findIndex(a => a.qIndex === currentQuestionIndex + 1);
            
            const newAnswerData = {
                qIndex: currentQuestionIndex + 1,
                questionText: qData.question,
                options: qData.options,
                userAnswerKey: selectedAnswer,
                correctAnswerKey: qData.correctAnswer,
                isCorrect: isCorrect
            };
            
            if (existingAnswerIndex > -1) {
                userAnswers[existingAnswerIndex] = newAnswerData;
            } else {
                userAnswers.push(newAnswerData);
            }

            // Calculate score (simple recount, as answers can change)
            score = userAnswers.filter(a => a.isCorrect).length;
        }
    }

    function displayQuestion() {
        if (currentQuestionIndex >= questions.length) {
            finishExam();
            return;
        }

        // Check if there's an ongoing auto-next timeout and clear it
        if (autoNextTimeout) {
            clearTimeout(autoNextTimeout);
            autoNextTimeout = null;
        }

        const qData = questions[currentQuestionIndex];
        const questionNumber = currentQuestionIndex + 1;
        
        // Retrieve recorded answer for display
        const recordedAnswer = userAnswers.find(a => a.qIndex === questionNumber);
        selectedAnswer = recordedAnswer ? recordedAnswer.userAnswerKey : null;
        
        document.getElementById('exam-progress').textContent = `Question ${questionNumber} of ${questions.length}`;
        document.getElementById('exam-topic-display').textContent = `Topic: ${examTopic} (${examLanguage})`;
        document.getElementById('current-question').textContent = `${questionNumber}. ${qData.question}`;

        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = ''; 

        const optionKeys = ['A', 'B', 'C', 'D'];
        optionKeys.forEach(key => {
            const optionText = qData.options[key];
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item p-4 bg-gray-50 hover:bg-blue-50 rounded-lg cursor-pointer transition-all';
            optionDiv.innerHTML = `<span class="font-bold text-blue-700 option-key">${key}.</span> ${optionText}`;
            optionDiv.dataset.key = key;

            // Apply 'option-selected' class if this option was previously selected
            if (key === selectedAnswer) {
                 optionDiv.classList.add('option-selected');
                 optionDiv.classList.remove('bg-gray-50', 'hover:bg-blue-50');
                 optionDiv.style.borderColor = '#1d4ed8';
            }

            optionDiv.onclick = function() {
                // 1. Visually select the option
                document.querySelectorAll('.option-item').forEach(item => {
                    item.classList.remove('option-selected');
                    item.classList.add('bg-gray-50', 'hover:bg-blue-50');
                    item.style.borderColor = '#e5e7eb';
                });
                
                optionDiv.classList.add('option-selected');
                optionDiv.classList.remove('bg-gray-50', 'hover:bg-blue-50');
                optionDiv.style.borderColor = '#1d4ed8';
                
                selectedAnswer = key;
                document.getElementById('next-btn').disabled = false;
                
                // 2. Clear previous timeout and set new auto-next
                if (autoNextTimeout) {
                    clearTimeout(autoNextTimeout);
                }
                // Use a short delay before advancing
                autoNextTimeout = setTimeout(function() {
                    nextQuestion(false); // Do not force next button action
                }, 1000); 
            };

            optionsContainer.appendChild(optionDiv);
        });
        
        document.getElementById('next-btn').textContent = (questionNumber === questions.length) ? 'Finish Exam & View Score' : 'Next Question';
        
        // Enable/disable navigation buttons
        document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
        document.getElementById('next-btn').disabled = !selectedAnswer; 
    }

    function nextQuestion(isManualClick) {
        // If manually clicking the Next button, clear the auto-next timeout
        if (isManualClick && autoNextTimeout) {
            clearTimeout(autoNextTimeout);
            autoNextTimeout = null;
        }

        if (!selectedAnswer) {
            showMessage("Please select an answer before proceeding.");
            document.getElementById('next-btn').disabled = true;
            return;
        }

        // 1. Record the answer for the current question
        recordAnswer();

        // 2. Advance the index
        currentQuestionIndex++;
        
        // 3. Display next question or finish
        displayQuestion();
    }
    
    function previousQuestion() {
        if (currentQuestionIndex > 0) {
            // Clear auto-next timeout if present
            if (autoNextTimeout) {
                clearTimeout(autoNextTimeout);
                autoNextTimeout = null;
            }

            // Record answer for the question being left (if selected)
            recordAnswer();
            
            // Go back
            currentQuestionIndex--;
            displayQuestion();
        }
    }

    function finishExam() {
        clearInterval(timerInterval);

        // Record the answer for the last question before finishing
        if (currentQuestionIndex === questions.length - 1 && selectedAnswer) {
            recordAnswer();
        }

        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) { 
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }

        document.getElementById('exam-screen').classList.add('hidden');
        document.getElementById('certificate-screen').classList.remove('hidden');
        
        generateCertificate();
    }

    function generateCertificate() {
        const percentage = (score / questions.length) * 100;
        const resultText = `${score} out of ${questions.length}`;
        const date = new Date().toLocaleDateString('en-IN', {
            day: 'numeric', year: 'numeric', month: 'long'
        });
        
        document.getElementById('cert-user-name').textContent = userName;
        document.getElementById('cert-exam-details').textContent = `${examTopic} (${examLanguage}).`;
        document.getElementById('cert-score-display').textContent = resultText;
        document.getElementById('cert-percentage-display').textContent = `(${percentage.toFixed(2)}%)`;
        document.getElementById('cert-date').textContent = date;
        
        const marksheetBtn = document.getElementById('marksheet-btn');
        const premiumMsg = document.getElementById('premium-marksheet-msg');

        if (isMarksheetUnlocked) {
            marksheetBtn.textContent = 'View Full Marksheet (Unlocked)';
            premiumMsg.classList.add('hidden');
        } else {
            marksheetBtn.textContent = 'View Full Marksheet (Premium Required)';
            premiumMsg.classList.remove('hidden');
        }
    }

    function checkMarksheetCode() {
        const inputCode = document.getElementById('marksheet-premium-code').value.trim().toUpperCase();
        if (inputCode === PREMIUM_CODE) {
            isMarksheetUnlocked = true;
            hidePremiumCodeModal();
            showMessage("Marksheet Unlocked! You can now view the detailed analysis.");
            document.getElementById('marksheet-btn').textContent = 'View Full Marksheet (Unlocked)';
            document.getElementById('premium-marksheet-msg').classList.add('hidden');
            
            buildMarksheet(true); 

        } else {
            showMessage("Incorrect Code. Please enter the correct code or contact us via WhatsApp.");
            document.getElementById('marksheet-premium-code').value = '';
        }
    }

    function toggleMarksheet() {
        const marksheetView = document.getElementById('marksheet-view');
        
        if (isMarksheetUnlocked) {
            marksheetView.classList.toggle('hidden');
            if (!marksheetView.classList.contains('hidden')) {
                buildMarksheet(false); 
            }
            document.getElementById('marksheet-btn').textContent = marksheetView.classList.contains('hidden') ? 'Hide Marksheet' : 'View Full Marksheet (Unlocked)';
        } else {
            showPremiumCodeModal();
            document.getElementById('premium-marksheet-msg').classList.remove('hidden');
        }
    }

    function buildMarksheet(isAutoShow) {
        const marksheetBody = document.getElementById('marksheet-body');
        marksheetBody.innerHTML = '';
        const marksheetView = document.getElementById('marksheet-view');

        // Ensure userAnswers is sorted by question index
        userAnswers.sort((a, b) => a.qIndex - b.qIndex);

        userAnswers.forEach(answer => {
            const row = document.createElement('tr');
            row.className = `border ${answer.isCorrect ? 'marksheet-correct' : 'marksheet-incorrect'} transition-colors`;

            const userAnswerText = answer.userAnswerKey ? answer.userAnswerKey + '. ' + (answer.options[answer.userAnswerKey] || "No Answer") : "No Answer Selected";
            const correctAnswerText = answer.correctAnswerKey + '. ' + answer.options[answer.correctAnswerKey];
            const resultIcon = answer.isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect';
            const resultClass = answer.isCorrect ? 'text-green-700 font-bold' : 'text-red-700 font-bold';
            
            row.innerHTML = `
                <td class="p-2 border font-bold">${answer.qIndex}</td>
                <td class="p-2 border">${answer.questionText}</td>
                <td class="p-2 border hidden sm:table-cell text-gray-800">${userAnswerText}</td>
                <td class="p-2 border font-semibold text-blue-700">${correctAnswerText}</td>
                <td class="p-2 border font-extrabold ${resultClass}">${resultIcon}</td>
            `;
            marksheetBody.appendChild(row);
        });
        
        if (isAutoShow) {
             marksheetView.classList.remove('hidden');
             document.getElementById('marksheet-btn').textContent = 'Hide Marksheet';
        }
    }

    function downloadCertificate() {
        showMessage("Certificate JPG Download In Progress...");
        
        const certificateElement = document.getElementById('certificate-content');
        const userName = document.getElementById('cert-user-name').textContent;

        html2canvas(certificateElement, { 
            scale: 2, 
            allowTaint: true,
            useCORS: true, 
            backgroundColor: '#ffffff'
        }).then(canvas => {
            const imageURL = canvas.toDataURL('image/jpeg', 0.9); 
            const link = document.createElement('a');
            link.href = imageURL;
            link.download = `DigitX_Certificate_${userName.replace(/\s/g, '_')}.jpg`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }).catch(err => {
            console.error("Certificate download error:", err);
            showMessage("Certificate Download Failed. Please Try Again.");
        });
    }

    // Initial setup on load
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DigitMCQ Master App Loaded. Ready for setup.");
        toggleCustomTopic(); 
    });
</script>

</body>
</html>

